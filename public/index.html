<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Analytics Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Floating toggle for collapsed state -->
    <button type="button" class="btn btn-secondary" id="sidebarToggleBtnFloating">
        <i class="fas fa-bars"></i>
    </button>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-heartbeat"></i> Health Analytics Dashboard</h1>
            <div class="header-controls">
                <div id="authUserBadge" class="auth-user-badge" style="display:none;">
                    <span id="authUserEmail" class="auth-user-email"></span>
                    <button id="logoutBtn" class="btn btn-secondary" style="padding:10px 14px;">
                        <i class="fas fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Auth Gate (shown until user logs in) -->
        <div id="authGate" class="auth-gate" style="display:none;">
            <div class="auth-card">
                <div class="auth-card__header">
                    <h2 style="margin:0; color:#111827; font-weight:900;">Welcome</h2>
                    <div style="color:#6b7280; font-weight:700; margin-top:6px;">
                        Log in to access your private health dashboard.
                    </div>
                </div>
                <div class="auth-card__tabs">
                    <button type="button" id="authTabLogin" class="btn btn-secondary auth-tab active">Login</button>
                    <button type="button" id="authTabSignup" class="btn btn-secondary auth-tab">Sign up</button>
                </div>
                <form id="loginForm" class="data-form" style="margin-top:14px;">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="loginEmail">Email</label>
                            <input id="loginEmail" type="email" autocomplete="email" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="loginPassword">Password</label>
                            <input id="loginPassword" type="password" autocomplete="current-password" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-right-to-bracket"></i> Login
                    </button>
                </form>
                <form id="signupForm" class="data-form" style="margin-top:14px; display:none;">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="signupEmail">Email</label>
                            <input id="signupEmail" type="email" autocomplete="email" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="signupPassword">Password</label>
                            <input id="signupPassword" type="password" autocomplete="new-password" minlength="8" required>
                            <small class="form-help">Minimum 8 characters.</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Create account
                    </button>
                </form>
                <div id="authError" style="display:none; margin-top:12px; color:#b91c1c; font-weight:800;"></div>
            </div>
        </div>

        <div class="app-main-layout">
            <!-- Navigation Sidebar -->
            <nav class="tab-navigation">
                <!-- Collapse toggle at top of menu -->
                <button type="button" class="tab-btn sidebar-collapse-btn" id="sidebarToggleBtnInMenu">
                    <i class="fas fa-angles-left"></i>
                    <span class="tab-label">Collapse Menu</span>
                </button>
                <button class="tab-btn active" data-tab="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span class="tab-label">Dashboard</span>
                </button>
                <button class="tab-btn" data-tab="morning-routine">
                    <i class="fas fa-list-check"></i>
                    <span class="tab-label">Morning Routine</span>
                </button>
                <button class="tab-btn" data-tab="evening-routine">
                    <i class="fas fa-moon"></i>
                    <span class="tab-label">Evening Routine</span>
                </button>
                <button class="tab-btn" data-tab="food">
                    <i class="fas fa-utensils"></i>
                    <span class="tab-label">Food</span>
                </button>
                <button class="tab-btn" data-tab="mood">
                    <i class="fas fa-smile"></i>
                    <span class="tab-label">Mood</span>
                </button>
                <button class="tab-btn" data-tab="journal">
                    <i class="fas fa-book"></i>
                    <span class="tab-label">Journal</span>
                </button>
                <button class="tab-btn" data-tab="fitness">
                    <i class="fas fa-dumbbell"></i>
                    <span class="tab-label">Fitness</span>
                </button>
                <button class="tab-btn" data-tab="activity">
                    <i class="fas fa-walking"></i>
                    <span class="tab-label">Activity</span>
                </button>
                <button class="tab-btn" data-tab="sleep">
                    <i class="fas fa-bed"></i>
                    <span class="tab-label">Sleep</span>
                </button>
                <button class="tab-btn" data-tab="supplements">
                    <i class="fas fa-pills"></i>
                    <span class="tab-label">Supplements</span>
                </button>
                <button class="tab-btn" data-tab="medications">
                    <i class="fas fa-prescription-bottle-alt"></i>
                    <span class="tab-label">Medications</span>
                </button>
                <button class="tab-btn" data-tab="insights">
                    <i class="fas fa-sparkles"></i>
                    <span class="tab-label">Insights</span>
                </button>
                <button class="tab-btn" data-tab="bodycomp">
                    <i class="fas fa-weight-scale"></i>
                    <span class="tab-label">Body Comp</span>
                </button>
                <button class="tab-btn" data-tab="analysis">
                    <i class="fas fa-brain"></i>
                    <span class="tab-label">Analysis</span>
                </button>
                <button class="tab-btn" data-tab="trends">
                    <i class="fas fa-wave-square"></i>
                    <span class="tab-label">Trends</span>
                </button>
                <button class="tab-btn" data-tab="labs">
                    <i class="fas fa-vial"></i>
                    <span class="tab-label">Labs</span>
                </button>
                <button class="tab-btn" data-tab="genetic">
                    <i class="fas fa-dna"></i>
                    <span class="tab-label">Genetic Data</span>
                </button>
                <button class="tab-btn" data-tab="garmin">
                    <i class="fas fa-running"></i>
                    <span class="tab-label">Device Import</span>
                </button>
            </nav>

            <div class="app-main-content">

        <!-- Labs Tab -->
        <div id="labs" class="tab-content">
            <div class="analysis-container">
                <div class="analysis-section">
                    <h2><i class="fas fa-vial"></i> Labs / Biomarkers</h2>
                    <p class="muted">Store blood test and biomarker results like insulin, IGF‑1, Omega‑3 Index, creatinine, testosterone, etc.</p>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-plus"></i> Add result</h3>
                    <form id="labsForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="labsDate">Date</label>
                                <input type="date" id="labsDate" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="labsBiomarker">Biomarker</label>
                                <input type="text" id="labsBiomarker" name="biomarker" placeholder="e.g. Insulin, IGF-1, Omega-3 Index" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="labsValueNum">Value (number)</label>
                                <input type="number" id="labsValueNum" name="value_num" step="0.0001" placeholder="e.g. 12.4">
                            </div>
                            <div class="form-group">
                                <label for="labsValueText">Value (text)</label>
                                <input type="text" id="labsValueText" name="value_text" placeholder="e.g. Positive / Negative">
                            </div>
                            <div class="form-group">
                                <label for="labsUnit">Unit</label>
                                <input type="text" id="labsUnit" name="unit" placeholder="e.g. µIU/mL, ng/dL">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="labsRefLow">Ref low</label>
                                <input type="number" id="labsRefLow" name="ref_low" step="0.0001">
                            </div>
                            <div class="form-group">
                                <label for="labsRefHigh">Ref high</label>
                                <input type="number" id="labsRefHigh" name="ref_high" step="0.0001">
                            </div>
                            <div class="form-group">
                                <label for="labsNotes">Notes</label>
                                <input type="text" id="labsNotes" name="notes" placeholder="optional">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Lab Result
                        </button>
                    </form>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-upload"></i> Import (CSV / Excel)</h3>
                    <form id="labsImportForm" class="upload-form">
                        <div class="form-group">
                            <label for="labsFile">Upload file</label>
                            <input type="file" id="labsFile" name="file" accept=".csv,.xlsx,.xls" required>
                            <small class="form-help">
                                Expected columns (any order): <code>date</code>, <code>biomarker</code>, <code>value</code>, <code>unit</code>, optional <code>ref_low</code>, <code>ref_high</code>, <code>notes</code>.
                            </small>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload"></i> Upload & Import
                        </button>
                    </form>
                    <div id="labsImportResults" class="garmin-status" style="margin-top: 12px;"></div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-chart-line"></i> Trend</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="labsSelect">Select biomarker</label>
                            <select id="labsSelect"></select>
                        </div>
                        <div class="form-group" style="align-self:end;">
                            <button type="button" class="btn btn-secondary" id="labsRefreshBtn">
                                <i class="fas fa-rotate"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3 id="labsChartTitle">Biomarker</h3>
                        <canvas id="labsChart"></canvas>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-table"></i> Latest results</h3>
                    <div class="garmin-status" id="labsList"></div>
                </div>
            </div>
        </div>

        <!-- Trends Tab -->
        <div id="trends" class="tab-content">
            <div class="analysis-container">
                <div class="analysis-section">
                    <h2><i class="fas fa-wave-square"></i> Trends</h2>
                    <p class="muted">All your data in one place (Garmin imports + manual inputs). Pick a range and review graphs + numbers.</p>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-calendar"></i> Range</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trendsFrom">From</label>
                            <input type="date" id="trendsFrom">
                        </div>
                        <div class="form-group">
                            <label for="trendsTo">To</label>
                            <input type="date" id="trendsTo">
                        </div>
                        <div class="form-group" style="align-self:end; display:flex; gap:10px; flex-wrap:wrap;">
                            <button type="button" class="btn btn-secondary" id="trendsLast30Btn">Last 30 days</button>
                            <button type="button" class="btn btn-secondary" id="trendsRefreshBtn">
                                <i class="fas fa-rotate"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-container">
                        <h3>Heart Rate (daily)</h3>
                        <canvas id="trendHeartRateChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Resting Heart Rate (daily)</h3>
                        <canvas id="trendRestingHrChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>HRV (daily)</h3>
                        <canvas id="trendHrvChart"></canvas>
                        <div class="muted" id="trendHrvHint" style="margin-top:8px;"></div>
                    </div>
                    <div class="chart-container">
                        <h3>Sleep Duration (hours)</h3>
                        <canvas id="trendSleepDurationChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Steps</h3>
                        <canvas id="trendStepsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Weight (kg)</h3>
                        <canvas id="trendWeightChart"></canvas>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-layer-group"></i> All Garmin metrics (auto)</h3>
                    <p class="muted">This section auto-creates a chart for every Garmin metric we have data for in the selected range (daily summary + sleep + training).</p>
                    <div class="charts-section" id="trendsAllMetrics"></div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-table"></i> Quick table (last 30 rows)</h3>
                    <div class="garmin-status" id="trendsTable"></div>
                </div>
            </div>
        </div>

        <!-- Insights Tab -->
        <div id="insights" class="tab-content">
            <div class="analysis-container">
                <div class="analysis-section">
                    <h2><i class="fas fa-sparkles"></i> Insights</h2>
                    <p class="muted">Weekly explanations based on your check-ins, journal signals, biometrics and logs.</p>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-calendar-week"></i> Weekly Report</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="insightsWeekStart">Week starting (Monday)</label>
                            <input type="date" id="insightsWeekStart">
                            <small class="form-help">Pick any date in the week; we’ll use the Monday of that week.</small>
                        </div>
                        <div class="form-group" style="align-self:end;">
                            <button type="button" id="refreshInsightsBtn" class="btn btn-secondary">
                                <i class="fas fa-wand-magic-sparkles"></i> Generate
                            </button>
                        </div>
                    </div>
                    <div id="weeklyInsightBox" class="info-panel" style="margin-top:14px;"></div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-face-smile"></i> Mood Check-ins</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="checkinMood">Mood (1–10)</label>
                            <input type="number" id="checkinMood" min="1" max="10" step="1" placeholder="e.g., 6">
                        </div>
                        <div class="form-group">
                            <label for="checkinStress">Stress (1–10)</label>
                            <input type="number" id="checkinStress" min="1" max="10" step="1" placeholder="e.g., 7">
                        </div>
                        <div class="form-group">
                            <label for="checkinEnergy">Energy (1–10)</label>
                            <input type="number" id="checkinEnergy" min="1" max="10" step="1" placeholder="e.g., 5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="checkinNotes">Notes (optional)</label>
                            <input type="text" id="checkinNotes" placeholder="e.g., annoyed after meeting">
                        </div>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <button type="button" id="saveCheckinBtn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Check-in
                        </button>
                    </div>
                    <div id="checkinsList" class="journal-list" style="margin-top:14px;"></div>
                </div>
            </div>
        </div>

        <!-- Morning Routine Tab -->
        <div id="morning-routine" class="tab-content">
            <div class="analysis-container">
                <div class="analysis-section">
                    <h2><i class="fas fa-list-check"></i> Morning Routine</h2>
                    <p class="muted">A quick checklist for your day. Items are private to your account.</p>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-sun"></i> Checklist</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="routineDate">Date</label>
                            <input type="date" id="routineDate">
                        </div>
                        <div class="form-group" style="align-self:end; display:flex; gap:10px; flex-wrap:wrap;">
                            <button type="button" id="routineSeedMetricsBtn" class="btn btn-secondary">
                                <i class="fas fa-wand-magic-sparkles"></i> Add recommended metrics
                            </button>
                            <button type="button" id="routineTodayBtn" class="btn btn-secondary">
                                <i class="fas fa-calendar-day"></i> Today
                            </button>
                            <button type="button" id="routineRefreshBtn" class="btn btn-secondary">
                                <i class="fas fa-rotate"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div id="routineProgress" class="info-panel" style="margin-top:14px;"></div>
                    <div id="routineChecklist" class="routine-list" style="margin-top:14px;"></div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-plus"></i> Add item</h3>
                    <form id="routineAddItemForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="routineItemKind">Type</label>
                                <select id="routineItemKind">
                                    <option value="yesno" selected>Yes / No</option>
                                    <option value="number">Number</option>
                                    <option value="text">Text</option>
                                    <option value="time">Time</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="routineItemTitle">Item</label>
                                <input type="text" id="routineItemTitle" placeholder="e.g., Drink water, Supplements, Walk, Stretching" required>
                                <small class="form-help">Tip: you can rename or delete items from the list.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="routineItemUnit">Unit (optional)</label>
                                <input type="text" id="routineItemUnit" placeholder="e.g., kg, bpm, %" />
                            </div>
                            <div class="form-group">
                                <label for="routineItemKey">Key (optional)</label>
                                <input type="text" id="routineItemKey" placeholder="e.g., weight_kg, bmi" />
                                <small class="form-help">If set to <b>weight_kg</b> or <b>bmi</b>, it will also write into Body Comp.</small>
                            </div>
                            <div class="form-group">
                                <label for="routineItemStep">Step (optional)</label>
                                <input type="number" id="routineItemStep" placeholder="e.g., 0.1" step="any" />
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Evening Routine Tab -->
        <div id="evening-routine" class="tab-content">
            <div class="analysis-container">
                <div class="analysis-section">
                    <h2><i class="fas fa-moon"></i> Evening Routine</h2>
                    <p class="muted">Track pre-bed habits and timings. Items are private to your account.</p>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-bed"></i> Checklist</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eveningRoutineDate">Date</label>
                            <input type="date" id="eveningRoutineDate">
                        </div>
                        <div class="form-group" style="align-self:end; display:flex; gap:10px; flex-wrap:wrap;">
                            <button type="button" id="eveningRoutineSeedBtn" class="btn btn-secondary">
                                <i class="fas fa-wand-magic-sparkles"></i> Add recommended items
                            </button>
                            <button type="button" id="eveningRoutineTodayBtn" class="btn btn-secondary">
                                <i class="fas fa-calendar-day"></i> Today
                            </button>
                            <button type="button" id="eveningRoutineRefreshBtn" class="btn btn-secondary">
                                <i class="fas fa-rotate"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div id="eveningRoutineProgress" class="info-panel" style="margin-top:14px;"></div>
                    <div id="eveningRoutineChecklist" class="routine-list" style="margin-top:14px;"></div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-plus"></i> Add item</h3>
                    <form id="eveningRoutineAddItemForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eveningRoutineItemKind">Type</label>
                                <select id="eveningRoutineItemKind">
                                    <option value="yesno" selected>Yes / No</option>
                                    <option value="number">Number</option>
                                    <option value="text">Text</option>
                                    <option value="time">Time</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="eveningRoutineItemTitle">Item</label>
                                <input type="text" id="eveningRoutineItemTitle" placeholder="e.g., No caffeine, No screens, Hot shower" required>
                                <small class="form-help">Tip: you can rename or delete items from the list.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eveningRoutineItemUnit">Unit (optional)</label>
                                <input type="text" id="eveningRoutineItemUnit" placeholder="e.g., mg, min" />
                            </div>
                            <div class="form-group">
                                <label for="eveningRoutineItemKey">Key (optional)</label>
                                <input type="text" id="eveningRoutineItemKey" placeholder="e.g., screen_time_minutes" />
                            </div>
                            <div class="form-group">
                                <label for="eveningRoutineItemStep">Step (optional)</label>
                                <input type="number" id="eveningRoutineItemStep" placeholder="e.g., 1" step="any" />
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Journal Tab -->
        <div id="journal" class="tab-content">
            <div class="journal-container">
                <div class="journal-section">
                    <h2><i class="fas fa-book"></i> Daily Journal</h2>
                    <p class="muted">
                        Write a quick daily entry. The app will extract mood/energy/stress signals (local model for now; LLM-ready later)
                        and use them for correlations with sleep, workouts, and activity.
                    </p>
                </div>

                <div class="journal-section">
                    <h3><i class="fas fa-pen"></i> New / Edit Entry</h3>
                    <form id="journalForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="journalDate">Date</label>
                                <input type="date" id="journalDate" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="journalTitle">Title (optional)</label>
                                <input type="text" id="journalTitle" name="title" placeholder="e.g., Great workout + solid sleep">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="journalContent">Journal Entry</label>
                                <textarea id="journalContent" name="content" rows="6" placeholder="How did you feel today? What happened? Sleep/workout/food notes..." required></textarea>
                                <small class="form-help">Tip: mention sleep, workouts, stress, energy, mood, food cravings, etc. to improve extraction.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="journalRunInsights" checked>
                                    Extract mood/energy/stress from this entry
                                </label>
                            </div>
                        </div>
                        <div style="display:flex; gap:12px; flex-wrap:wrap;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Entry
                            </button>
                            <button type="button" id="journalAnalyzeBtn" class="btn btn-secondary">
                                <i class="fas fa-wand-magic-sparkles"></i> Re-analyze Entry
                            </button>
                        </div>
                        <div id="journalLatestInsights" class="info-panel" style="margin-top:16px; display:none;"></div>
                    </form>
                </div>

                <div class="journal-section">
                    <h3><i class="fas fa-clock"></i> Recent Entries</h3>
                    <div id="journalList" class="journal-list">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Food Tab -->
        <div id="food" class="tab-content">
            <div class="foodscan-container">
                <div class="foodscan-section">
                    <h2><i class="fas fa-utensils"></i> Food</h2>
                    <p class="muted">
                        Manually log food, scan barcodes, or analyze photos/packaging with AI to estimate calories/macros.
                    </p>
                </div>

                <div class="foodscan-section">
                    <h3><i class="fas fa-apple-alt"></i> Manual Food Log</h3>
                    <div class="data-card">
                        <div class="card-header">
                            <h3><i class="fas fa-apple-alt"></i> Food Log</h3>
                        </div>
                        <div class="card-content expanded" id="foodLogCard">
                            <div class="form-row" style="align-items:end; margin-bottom: 10px;">
                                <div class="form-group" style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button type="button" class="btn btn-secondary" id="foodLogGoPhotoBtn">
                                        <i class="fas fa-camera"></i> AI Photo Calories
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="foodLogGoBarcodeBtn">
                                        <i class="fas fa-barcode"></i> Scan Barcode
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="foodLogGoPackagingBtn">
                                        <i class="fas fa-box"></i> Analyze Packaging
                                    </button>
                                </div>
                            </div>
                            <form id="foodLogForm" class="data-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="foodDate">Date</label>
                                        <input type="date" id="foodDate" name="date" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="foodName">Food Name</label>
                                        <input type="text" id="foodName" name="food_name" required placeholder="e.g., chicken tikka breast">
                                        <small class="form-help">Tip: include brand/restaurant if you can.</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Quantity</label>
                                        <div style="display:flex; gap:10px; align-items:center;">
                                            <input type="number" id="foodQty" name="quantity" step="0.1" min="0" placeholder="e.g., 350" style="max-width:140px;">
                                            <select id="foodQtyUnit" name="quantity_unit" style="max-width:160px;">
                                                <option value="g">g</option>
                                                <option value="ml">ml</option>
                                                <option value="serving">serving</option>
                                                <option value="piece">piece</option>
                                            </select>
                                            <button type="button" class="btn btn-secondary" id="foodAiEstimateBtn" style="padding:10px 14px;">
                                                <i class="fas fa-wand-magic-sparkles"></i> Estimate
                                            </button>
                                        </div>
                                        <small class="form-help">Uses AI to estimate calories + macros for this quantity.</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="foodCalories">Calories</label>
                                        <input type="number" id="foodCalories" name="calories">
                                    </div>
                                    <div class="form-group">
                                        <label for="servingSize">Serving Size</label>
                                        <input type="text" id="servingSize" name="serving_size" placeholder="e.g., 1 cup, 100g">
                                    </div>
                                    <div class="form-group">
                                        <label for="foodTime">Time (optional)</label>
                                        <input type="time" id="foodTime" name="time">
                                    </div>
                                </div>
                                <div id="foodAiEstimateResult" class="garmin-status" style="display:none; margin: 8px 0;"></div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="foodProtein">Protein (g)</label>
                                        <input type="number" id="foodProtein" name="protein_g" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label for="foodCarbs">Carbs (g)</label>
                                        <input type="number" id="foodCarbs" name="carbs_g" step="0.1">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="foodFat">Fat (g)</label>
                                        <input type="number" id="foodFat" name="fat_g" step="0.1">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Log Food Entry
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="foodscan-section">
                    <h3><i class="fas fa-upload"></i> Capture / Upload</h3>
                    <form id="foodPhotoForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="foodPhotoDate">Date</label>
                                <input type="date" id="foodPhotoDate" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="foodPhotoFile">Food Photo</label>
                                <input type="file" id="foodPhotoFile" name="photo" accept="image/*" capture="environment" required>
                                <small class="form-help">On mobile, this should open your camera.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="foodPhotoNotes">Notes (optional but helps)</label>
                                <textarea id="foodPhotoNotes" name="notes" rows="3" placeholder="e.g., chicken burrito bowl, extra rice, no cheese"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="foodPhotoAddToNutrition" checked>
                                    Add estimate to daily Nutrition totals
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="foodPhotoAddToFoodLog" checked>
                                    Add item to Food Log
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-wand-magic-sparkles"></i> Upload & Analyze
                        </button>
                    </form>

                    <div id="foodPhotoResult" class="foodscan-result" style="display:none;"></div>
                </div>

                <div class="foodscan-section">
                    <h3><i class="fas fa-barcode"></i> Scan Barcode (Packaging)</h3>
                    <p class="muted">Best accuracy comes from barcode/GTIN on the packaging. If supported, your browser can scan it live.</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="barcodeInput">Barcode / GTIN</label>
                            <input type="text" id="barcodeInput" placeholder="e.g., 5012345678900">
                            <small class="form-help">If you don’t have camera access, type the barcode here.</small>
                        </div>
                        <div class="form-group" style="align-self:end;">
                            <button type="button" id="startBarcodeBtn" class="btn btn-secondary">
                                <i class="fas fa-camera"></i> Start Scanner
                            </button>
                        </div>
                        <div class="form-group" style="align-self:end;">
                            <button type="button" id="lookupBarcodeBtn" class="btn btn-primary">
                                <i class="fas fa-magnifying-glass"></i> Lookup
                            </button>
                        </div>
                    </div>
                    <div id="barcodeScannerWrap" class="table-card" style="display:none;">
                        <div class="table-scroll" style="max-height:none;">
                            <div style="padding:14px;">
                                <video id="barcodeVideo" autoplay playsinline style="width:100%; max-height:320px; border-radius:12px; border:1px solid #e5e7eb; background:#000;"></video>
                                <div class="table-footer-note">Point the camera at the barcode. We’ll stop automatically when detected.</div>
                            </div>
                        </div>
                    </div>
                    <div id="barcodeLookupResult" class="foodscan-result" style="display:none;"></div>
                </div>

                <div class="foodscan-section" id="packagingScanSection">
                    <h3><i class="fas fa-box-open"></i> Analyze Packaging (Ingredients + Nutrition)</h3>
                    <p class="muted">
                        Take several photos: front of pack, ingredients list, and nutrition label (per 100g + per serving).
                        The app will extract ingredients + nutrition and can log it to your Food Log / Nutrition totals.
                    </p>
                    <form id="foodPackagingForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="foodPackagingDate">Date</label>
                                <input type="date" id="foodPackagingDate" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="foodPackagingGtin">Barcode / GTIN (optional)</label>
                                <input type="text" id="foodPackagingGtin" name="gtin" placeholder="e.g., 5012345678900">
                                <small class="form-help">If provided, we’ll save the extracted product into your local products DB for future barcode lookups.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="foodPackagingFiles">Packaging Photos</label>
                                <div class="packaging-upload-grid">
                                    <div>
                                        <input type="file" id="foodPackagingFiles" name="photos" accept="image/*" capture="environment" multiple>
                                        <small class="form-help">Tip: take 2–5 close-ups. Blurry ingredients/nutrition text reduces accuracy.</small>
                                    </div>
                                    <div>
                                        <div id="foodPackagingPasteZone" class="paste-dropzone" tabindex="0">
                                            <div class="paste-dropzone__title">Paste / drag & drop screenshots here</div>
                                            <div class="paste-dropzone__meta">Click this box, then press ⌘V / Ctrl+V</div>
                                        </div>
                                        <div class="paste-dropzone__actions">
                                            <button type="button" class="btn btn-secondary" id="foodPackagingClearPhotosBtn" style="padding:8px 12px;">
                                                <i class="fas fa-trash"></i> Clear photos
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="foodPackagingPreview" class="photo-preview-grid" style="margin-top: 10px;"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="foodPackagingNotes">Notes (optional)</label>
                                <textarea id="foodPackagingNotes" name="notes" rows="2" placeholder="e.g. serving size, how much you ate, brand/flavour"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="foodPackagingModel">Model (accuracy vs cost)</label>
                                <select id="foodPackagingModel" name="model">
                                    <option value="">Loading models…</option>
                                </select>
                                <small class="form-help">Prices shown are OpenRouter list prices (per 1M input/output tokens, plus image/request if applicable).</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="foodPackagingAddToNutrition" checked>
                                    Add to daily Nutrition totals (uses per-serving if found)
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="foodPackagingAddToFoodLog" checked>
                                    Add item to Food Log
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-wand-magic-sparkles"></i> Analyze Packaging
                        </button>
                    </form>
                    <div id="foodPackagingResult" class="foodscan-result" style="display:none;"></div>
                </div>

                <div class="foodscan-section">
                    <h3><i class="fas fa-history"></i> Recent Food Photos</h3>
                    <div id="foodPhotoList" class="journal-list">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sleep Tab -->
        <div id="sleep" class="tab-content">
            <div class="data-entry-container">
                <div class="data-card">
                    <div class="card-header">
                        <h3><i class="fas fa-bed"></i> Sleep Tracking</h3>
                    </div>
                    <div class="card-content" id="sleepCard">
                        <form id="sleepForm" class="data-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="sleepDate">Date</label>
                                    <input type="date" id="sleepDate" name="date" required>
                                </div>
                                <div class="form-group">
                                    <label for="sleepScore">Sleep Score (1-10)</label>
                                    <input type="number" id="sleepScore" name="score" min="1" max="10" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="durationHours">Duration (hours)</label>
                                    <input type="number" id="durationHours" name="duration_hours" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label for="deepSleep">Deep Sleep (hours)</label>
                                    <input type="number" id="deepSleep" name="deep_sleep_hours" step="0.1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="remSleep">REM Sleep (hours)</label>
                                    <input type="number" id="remSleep" name="rem_sleep_hours" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="bedtime">Bedtime</label>
                                    <input type="time" id="bedtime" name="bedtime">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wakeTime">Wake Time</label>
                                    <input type="time" id="wakeTime" name="wake_time">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Sleep Data
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Tab -->
        <div id="activity" class="tab-content">
            <div class="data-entry-container">
                <div class="data-card">
                    <div class="card-header">
                        <h3><i class="fas fa-walking"></i> Activity Monitoring</h3>
                    </div>
                    <div class="card-content" id="activityCard">
                        <form id="activityForm" class="data-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="activityDate">Date</label>
                                    <input type="date" id="activityDate" name="date" required>
                                </div>
                                <div class="form-group">
                                    <label for="steps">Steps</label>
                                    <input type="number" id="steps" name="steps" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="caloriesBurned">Calories Burned</label>
                                    <input type="number" id="caloriesBurned" name="calories_burned">
                                </div>
                                <div class="form-group">
                                    <label for="heartRateAvg">Average Heart Rate</label>
                                    <input type="number" id="heartRateAvg" name="heart_rate_avg">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="activeMinutes">Active Minutes</label>
                                    <input type="number" id="activeMinutes" name="active_minutes">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Activity Data
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mood Tab -->
        <div id="mood" class="tab-content">
            <div class="data-entry-container">
                <div class="data-card">
                    <div class="card-header">
                        <h3><i class="fas fa-smile"></i> Mood & Stress Tracking</h3>
                    </div>
                    <div class="card-content" id="moodCard">
                        <form id="moodForm" class="data-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="moodDate">Date</label>
                                    <input type="date" id="moodDate" name="date" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="moodScore">Mood Score (1-10)</label>
                                    <input type="range" id="moodScore" name="mood_score" min="1" max="10" value="5">
                                    <span class="range-value">5</span>
                                </div>
                                <div class="form-group">
                                    <label for="energyScore">Energy Score (1-10)</label>
                                    <input type="range" id="energyScore" name="energy_score" min="1" max="10" value="5">
                                    <span class="range-value">5</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="stressScore">Stress Score (1-10)</label>
                                    <input type="range" id="stressScore" name="stress_score" min="1" max="10" value="5">
                                    <span class="range-value">5</span>
                                </div>
                                <div class="form-group">
                                    <label for="anxietyScore">Anxiety Score (1-10)</label>
                                    <input type="range" id="anxietyScore" name="anxiety_score" min="1" max="10" value="5">
                                    <span class="range-value">5</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="moodNotes">Notes</label>
                                    <textarea id="moodNotes" name="notes" rows="3" placeholder="Any additional notes about your mood or stress levels..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Mood Data
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Supplements Tab -->
        <div id="supplements" class="tab-content">
            <div class="data-entry-container">
                <div class="data-card">
                    <div class="card-header">
                        <h3><i class="fas fa-pills"></i> Supplements Tracking</h3>
                    </div>
                    <div class="card-content" id="supplementsCard" style="display:block;">
                        <div class="form-row" style="align-items:end;">
                            <div class="form-group">
                                <label for="supplementsDayDate">Date</label>
                                <input type="date" id="supplementsDayDate">
                                <small class="form-help">Defaults are assumed “taken” unless you override below.</small>
                            </div>
                            <div class="form-group" style="align-self:end;">
                                <button type="button" class="btn btn-secondary" id="supplementsDayRefreshBtn">
                                    <i class="fas fa-rotate"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div id="supplementsDayList" class="routine-list supplements-day-list" style="margin-top: 12px;"></div>

                        <div style="margin-top:16px; border-top:1px solid rgba(0,0,0,.08); padding-top:16px;">
                            <h4 style="margin:0 0 10px 0; color:#4a5568;"><i class="fas fa-repeat"></i> Add recurring supplement</h4>
                            <form id="supplementRegimenForm" class="data-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="suppRegName">Name</label>
                                        <input type="text" id="suppRegName" required placeholder="e.g. Omega-3, Creatine">
                                    </div>
                                    <div class="form-group">
                                        <label for="suppRegDoseValue">Dose</label>
                                        <input type="number" id="suppRegDoseValue" step="0.01" placeholder="e.g. 1000">
                                    </div>
                                    <div class="form-group">
                                        <label for="suppRegDoseUnit">Unit</label>
                                        <input type="text" id="suppRegDoseUnit" placeholder="e.g. mg, g, capsules">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="suppRegTime1">Default time 1</label>
                                        <input type="time" id="suppRegTime1" value="08:00">
                                    </div>
                                    <div class="form-group">
                                        <label for="suppRegTime2">Default time 2 (optional)</label>
                                        <input type="time" id="suppRegTime2">
                                    </div>
                                    <div class="form-group">
                                        <label for="suppRegFrequency">Frequency</label>
                                        <select id="suppRegFrequency">
                                            <option value="daily">Daily</option>
                                            <option value="weekdays">Weekdays</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Add regimen
                                </button>
                            </form>
                            <div style="margin-top: 14px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                                    <div style="font-weight:900; color:#111827;">Your recurring supplements</div>
                                    <button type="button" class="btn btn-secondary" id="suppRegimensRefreshBtn" style="padding:8px 12px;">
                                        <i class="fas fa-rotate"></i> Refresh
                                    </button>
                                </div>
                                <div id="supplementRegimensList" class="routine-list supplements-regimens-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medications Tab -->
        <div id="medications" class="tab-content">
            <div class="data-entry-container">
                <div class="data-card">
                    <div class="card-header">
                        <h3><i class="fas fa-prescription-bottle-alt"></i> Medications Logging</h3>
                    </div>
                    <div class="card-content" id="medicationsCard" style="display:block;">
                        <div class="form-row" style="align-items:end;">
                            <div class="form-group">
                                <label for="medicationsDayDate">Date</label>
                                <input type="date" id="medicationsDayDate">
                                <small class="form-help">Defaults are assumed “taken” unless you override below.</small>
                            </div>
                            <div class="form-group" style="align-self:end;">
                                <button type="button" class="btn btn-secondary" id="medicationsDayRefreshBtn">
                                    <i class="fas fa-rotate"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div id="medicationsDayList" class="routine-list medications-day-list" style="margin-top: 12px;"></div>

                        <div style="margin-top:16px; border-top:1px solid rgba(0,0,0,.08); padding-top:16px;">
                            <h4 style="margin:0 0 10px 0; color:#4a5568;"><i class="fas fa-repeat"></i> Add recurring medication</h4>
                            <form id="medicationRegimenForm" class="data-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="medRegName">Name</label>
                                        <input type="text" id="medRegName" required placeholder="e.g. Metformin, Vitamin D">
                                    </div>
                                    <div class="form-group">
                                        <label for="medRegDoseValue">Dose</label>
                                        <input type="number" id="medRegDoseValue" step="0.01" placeholder="e.g. 500">
                                    </div>
                                    <div class="form-group">
                                        <label for="medRegDoseUnit">Unit</label>
                                        <input type="text" id="medRegDoseUnit" placeholder="e.g. mg, g, tablets">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="medRegTime1">Default time 1</label>
                                        <input type="time" id="medRegTime1" value="08:00">
                                    </div>
                                    <div class="form-group">
                                        <label for="medRegTime2">Default time 2 (optional)</label>
                                        <input type="time" id="medRegTime2">
                                    </div>
                                    <div class="form-group">
                                        <label for="medRegFrequency">Frequency</label>
                                        <select id="medRegFrequency">
                                            <option value="daily">Daily</option>
                                            <option value="weekdays">Weekdays</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Add regimen
                                </button>
                            </form>
                            <div style="margin-top: 14px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                                    <div style="font-weight:900; color:#111827;">Your recurring medications</div>
                                    <button type="button" class="btn btn-secondary" id="medRegimensRefreshBtn" style="padding:8px 12px;">
                                        <i class="fas fa-rotate"></i> Refresh
                                    </button>
                                </div>
                                <div id="medicationRegimensList" class="routine-list medications-regimens-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fitness Tab -->
        <div id="fitness" class="tab-content">
            <div class="fitness-container">
                <div class="fitness-section">
                    <h2><i class="fas fa-dumbbell"></i> Fitness Logging</h2>
                    <p class="muted">Log runs and strength workouts. Track progress over time with charts.</p>
                </div>

                <!-- Shared exercise library datalist (used by sets + charts) -->
                <datalist id="exerciseDatalist"></datalist>

                <div class="fitness-section">
                    <h3><i class="fas fa-person-running"></i> Log a Run</h3>
                    <form id="runForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="runDate">Date</label>
                                <input type="date" id="runDate" required>
                            </div>
                            <div class="form-group">
                                <label for="runDistance">Distance (km)</label>
                                <input type="number" id="runDistance" step="0.01" min="0" placeholder="e.g., 5.00" required>
                            </div>
                            <div class="form-group">
                                <label for="runDuration">Duration (minutes)</label>
                                <input type="number" id="runDuration" step="0.1" min="0" placeholder="e.g., 28.5" required>
                            </div>
                            <div class="form-group">
                                <label for="runCalories">Calories (optional)</label>
                                <input type="number" id="runCalories" min="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="runNotes">Notes (optional)</label>
                                <textarea id="runNotes" rows="2" placeholder="e.g., easy pace, felt great"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Run
                        </button>
                    </form>
                </div>

                <div class="fitness-section">
                    <h3><i class="fas fa-dumbbell"></i> Log Strength Workout</h3>
                    <form id="strengthForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="strengthDate">Date</label>
                                <input type="date" id="strengthDate" required>
                            </div>
                            <div class="form-group">
                                <label for="strengthName">Workout Name (optional)</label>
                                <input type="text" id="strengthName" placeholder="e.g., Push Day">
                            </div>
                            <div class="form-group">
                                <label for="strengthDuration">Duration (minutes, optional)</label>
                                <input type="number" id="strengthDuration" step="1" min="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="strengthNotes">Notes (optional)</label>
                                <textarea id="strengthNotes" rows="2" placeholder="e.g., good pump, shoulder felt tight"></textarea>
                            </div>
                        </div>

                        <div class="table-card" style="margin-top:10px;">
                            <div class="table-scroll">
                                <table class="data-table" id="setsTable">
                                    <thead>
                                        <tr>
                                            <th>Exercise</th>
                                            <th class="num">Reps</th>
                                            <th class="num">Weight (kg)</th>
                                            <th class="num">RPE</th>
                                            <th class="num">Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody id="setsTbody">
                                        <!-- JS adds rows -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-footer-note">
                                Add each set you performed. Estimated 1RM uses Epley: weight × (1 + reps/30).
                            </div>
                        </div>

                        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
                            <button type="button" id="addSetBtn" class="btn btn-secondary">
                                <i class="fas fa-plus"></i> Add Set
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Strength Workout
                            </button>
                        </div>
                    </form>
                </div>

                <div class="fitness-section">
                    <h3><i class="fas fa-layer-group"></i> Exercise Library</h3>
                    <p class="muted">Exercises are stored in the shared SQLite database. Adding here updates the picker for everyone using this app.</p>
                    <form id="exerciseAddForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="exerciseName">Exercise Name</label>
                                <input type="text" id="exerciseName" placeholder="e.g., Bench Press" required>
                            </div>
                            <div class="form-group">
                                <label for="exerciseMuscleGroup">Muscle Group (optional)</label>
                                <input type="text" id="exerciseMuscleGroup" placeholder="e.g., Chest">
                            </div>
                            <div class="form-group">
                                <label for="exerciseEquipment">Equipment (optional)</label>
                                <input type="text" id="exerciseEquipment" placeholder="e.g., Barbell">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="exerciseTags">Tags (optional)</label>
                                <input type="text" id="exerciseTags" placeholder="comma-separated: push, compound, upper">
                                <small class="form-help">Tip: tags help search/autocomplete later.</small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Add Exercise
                        </button>
                    </form>
                    <div id="exerciseLibraryList" class="journal-list" style="margin-top:12px;"></div>
                </div>

                <div class="fitness-section">
                    <h3><i class="fas fa-chart-line"></i> Progress Charts</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exerciseSelect">Strength Exercise</label>
                            <input type="text" id="exerciseSelect" list="exerciseDatalist" placeholder="e.g., Bench Press">
                            <small class="form-help">Enter an exercise name to chart estimated 1RM over time.</small>
                        </div>
                        <div class="form-group" style="align-self:end;">
                            <button type="button" id="refreshFitnessBtn" class="btn btn-secondary">
                                <i class="fas fa-rotate"></i> Refresh Charts
                            </button>
                        </div>
                    </div>
                    <div class="charts-section" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));">
                        <div class="chart-container">
                            <h3>Run Distance (km)</h3>
                            <canvas id="runDistanceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Run Pace (min/km)</h3>
                            <canvas id="runPaceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Strength Estimated 1RM (kg)</h3>
                            <canvas id="strength1rmChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Strength Volume (kg)</h3>
                            <canvas id="strengthVolumeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="fitness-section">
                    <h3><i class="fas fa-list"></i> Recent Workouts</h3>
                    <div id="fitnessRecent" class="journal-list"></div>
                </div>
            </div>
        </div>

        <!-- Body Composition Tab -->
        <div id="bodycomp" class="tab-content">
            <div class="bodycomp-container">
                <div class="bodycomp-section">
                    <h2><i class="fas fa-weight-scale"></i> Body Composition</h2>
                    <p class="muted">Import your Hume/BodyPod CSV exports and track weight, body fat, BMI and more over time.</p>
                </div>

                <div class="bodycomp-section">
                    <h3><i class="fas fa-upload"></i> Import CSV / Excel</h3>
                    <form id="bodyCompImportForm" class="data-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bodyCompSource">Source</label>
                                <select id="bodyCompSource">
                                    <option value="hume_csv" selected>Hume (CSV)</option>
                                    <option value="bodypod_csv">BodyPod (CSV)</option>
                                    <option value="other_csv">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="bodyCompFile">File</label>
                                <input type="file" id="bodyCompFile" accept=".csv,.xlsx,.xls" required>
                                <small class="form-help">Export from your scale app as CSV (preferred) and upload here.</small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-file-import"></i> Import
                        </button>
                    </form>
                    <div id="bodyCompImportResult" class="foodscan-result" style="display:none;"></div>
                </div>

                <div class="bodycomp-section">
                    <h3><i class="fas fa-chart-line"></i> Trends</h3>
                    <div class="charts-section" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));">
                        <div class="chart-container">
                            <h3>Weight (kg)</h3>
                            <canvas id="weightChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Body Fat (%)</h3>
                            <canvas id="bodyFatChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>BMI</h3>
                            <canvas id="bmiChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Hydration (%)</h3>
                            <canvas id="hydrationChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bodycomp-section">
                    <h3><i class="fas fa-list"></i> Recent Measurements</h3>
                    <div id="bodyCompList" class="journal-list"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <!-- Key Metrics Cards -->
                <div class="metrics-grid">
                    <div class="metric-card" id="sleepMetricCard">
                        <div class="metric-icon">
                            <i class="fas fa-bed"></i>
                        </div>
                        <div class="metric-info">
                            <h3>Sleep (last)</h3>
                            <div class="metric-value" id="avgSleepScore">--</div>
                            <div class="metric-trend" id="sleepTrend">--</div>
                        </div>
                    </div>
                    
                    <div class="metric-card" id="stepsMetricCard">
                        <div class="metric-icon">
                            <i class="fas fa-walking"></i>
                        </div>
                        <div class="metric-info">
                            <h3>Steps (yesterday)</h3>
                            <div class="metric-value" id="avgSteps">--</div>
                            <div class="metric-trend" id="stepsTrend">--</div>
                        </div>
                    </div>

                    <div class="metric-card" id="caloriesCard">
                        <div class="metric-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="metric-info">
                            <h3>Calories (today)</h3>
                            <div class="metric-value" id="todayCalories">--</div>
                            <div class="metric-trend" id="caloriesTrend">--</div>
                            <div style="margin-top:10px;">
                                <button type="button" class="btn btn-secondary" id="setCalorieGoalBtn" style="padding:8px 12px; box-shadow:none;">
                                    <i class="fas fa-bullseye"></i> Set goal
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card" id="moodMetricCard">
                        <div class="metric-icon">
                            <i class="fas fa-smile"></i>
                        </div>
                        <div class="metric-info">
                            <h3>Mood Score</h3>
                            <div class="metric-value" id="avgMood">--</div>
                            <div class="metric-trend">Last 7 days</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="metric-info">
                            <h3>Resting HR (yesterday)</h3>
                            <div class="metric-value" id="avgHeartRate">--</div>
                            <div class="metric-trend" id="hrTrend">--</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h3>Sleep Quality Trend</h3>
                        <canvas id="sleepChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Activity Overview</h3>
                        <canvas id="activityChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Mood & Energy</h3>
                        <canvas id="moodChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Nutrition Breakdown</h3>
                        <canvas id="nutritionChart"></canvas>
                    </div>
                </div>

                <!-- Recent Entries -->
                <div class="recent-entries">
                    <h3>Recent Data Entries</h3>
                    <div id="recentEntriesList" class="entries-list">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="analysis-container">
                <div class="analysis-section">
                    <h3><i class="fas fa-chart-line"></i> Correlation Analysis</h3>
                    <div class="correlation-controls">
                        <button id="runCorrelationBtn" class="btn btn-primary">
                            <i class="fas fa-calculator"></i> Run Correlation Analysis
                        </button>
                    </div>
                    <div id="correlationResults" class="correlation-results">
                        <!-- Correlation results will be displayed here -->
                    </div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-pills"></i> Drug Interaction Checker</h3>
                    <div class="interaction-checker">
                        <button id="checkInteractionsBtn" class="btn btn-warning">
                            <i class="fas fa-exclamation-triangle"></i> Check Interactions
                        </button>
                        <div id="interactionResults" class="interaction-results">
                            <!-- Interaction results will be displayed here -->
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3><i class="fas fa-lightbulb"></i> Pattern Detection & Recommendations</h3>
                    <div class="recommendations">
                        <button id="generateRecommendationsBtn" class="btn btn-info">
                            <i class="fas fa-magic"></i> Generate Recommendations
                        </button>
                        <div id="recommendationsResults" class="recommendations-results">
                            <!-- Recommendations will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Genetic Data Tab -->
        <div id="genetic" class="tab-content">
            <div class="genetic-container">
                <div class="genetic-section">
                    <h3><i class="fas fa-dna"></i> Genetic Data Upload</h3>
                    <div class="upload-section">
                        <form id="geneticUploadForm" class="upload-form">
                            <div class="form-group">
                                <label for="geneticFile">Upload Genetic Data (CSV or Excel)</label>
                                <input type="file" id="geneticFile" name="geneticFile" accept=".csv,.xlsx,.xls" required>
                                <small class="form-help">Upload your genetic data in CSV, Excel (.xlsx), or Numbers (.xls) format for analysis</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload & Analyze
                            </button>
                        </form>
                    </div>
                </div>

                <div class="genetic-section">
                    <h3><i class="fas fa-chart-bar"></i> Genetic Analysis Results</h3>
                    <div id="geneticResults" class="genetic-results">
                        <!-- Genetic analysis results will be displayed here -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Device Import Tab -->
        <div id="garmin" class="tab-content">
            <div class="garmin-container">
                <div class="garmin-section">
                    <h2><i class="fas fa-running"></i> Device Data Import</h2>
                    <p style="color: #718096; margin-bottom: 30px;">
                        Import your health and fitness data from Garmin devices and other fitness trackers. 
                        Automatically populate your dashboard with activity, sleep, heart rate, and stress data.
                    </p>
                </div>

                <div class="garmin-section">
                    <h3><i class="fas fa-upload"></i> Garmin Data Import</h3>
                    <div class="upload-section">
                        <form id="garminUploadForm" class="upload-form">
                            <div class="form-group">
                                <label for="garminFile">Upload Garmin Data File</label>
                                <input type="file" id="garminFile" name="garminFile" accept=".csv,.xlsx,.xls,.tcx,.gpx" required>
                                <small class="form-help">
                                    Upload your Garmin data files to automatically import activity, sleep, heart rate, and stress data.
                                    <br><strong>Supported formats:</strong> CSV, Excel (.xlsx, .xls), TCX, GPX
                                    <br><strong>How to export:</strong> Go to Garmin Connect → Reports → Export Data, or use files directly from your device.
                                </small>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-upload"></i> Upload & Import Garmin Data
                            </button>
                        </form>
                    </div>
                    <div id="garminImportResults" class="garmin-status" style="margin-top: 20px;">
                        <!-- Import results will be displayed here -->
                    </div>
                </div>

                <div class="garmin-section">
                    <h3><i class="fas fa-arrows-rotate"></i> Garmin Connect Auto Sync (GarminDB)</h3>
                    <div class="upload-section">
                        <div class="form-row" style="align-items:end;">
                            <div class="form-group">
                                <label for="garminDbDays">Import last N days</label>
                                <input type="number" id="garminDbDays" min="1" max="365" value="30">
                                <small class="form-help">
                                    This runs GarminDB locally to download from Garmin Connect, then imports daily summaries into this app.
                                    <br><b>Personal-use only.</b> Requires Python + GarminDB configured in <code>~/.GarminDb</code>.
                                </small>
                            </div>
                            <div class="form-group" style="min-width:260px;">
                                <label>Import options</label>
                                <div style="display:flex;flex-direction:column;gap:8px;padding:10px 0;">
                                    <label style="display:flex;gap:10px;align-items:center;">
                                        <input type="checkbox" id="garminDbIncludeDaily" checked>
                                        <span>Daily metrics (sleep/steps/calories/stress/body battery…)</span>
                                    </label>
                                    <label style="display:flex;gap:10px;align-items:center;">
                                        <input type="checkbox" id="garminDbIncludeWorkouts" checked>
                                        <span>Workout sessions (runs/walks/etc)</span>
                                    </label>
                                    <label style="display:flex;gap:10px;align-items:center;">
                                        <input type="checkbox" id="garminDbIncludeSamples">
                                        <span>Raw HR samples (high volume)</span>
                                    </label>
                                    <div style="display:flex;gap:10px;align-items:center;opacity:.9;">
                                        <span style="min-width:110px;">Samples days</span>
                                        <input type="number" id="garminDbSamplesDays" min="1" max="365" value="7" style="max-width:120px;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group" style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button type="button" id="garminDbSyncBtn" class="btn btn-success">
                                    <i class="fas fa-arrows-rotate"></i> Run Auto Sync
                                </button>
                            </div>
                        </div>
                        <div id="garminDbSyncResults" class="garmin-status" style="margin-top: 12px;"></div>
                    </div>
                </div>

                <div class="garmin-section">
                    <h3><i class="fas fa-apple-alt"></i> Apple Health Import</h3>
                    <div class="upload-section">
                        <form id="appleHealthUploadForm" class="upload-form">
                            <div class="form-group">
                                <label for="appleHealthFile">Upload Apple Health export.xml</label>
                                <input type="file" id="appleHealthFile" name="appleHealthFile" accept=".xml" required>
                                <small class="form-help">
                                    Apple Health doesn’t allow direct access from a web app. The practical way is:
                                    <br>Health app → Profile → <strong>Export All Health Data</strong> → unzip the export → upload <strong>export.xml</strong> here.
                                    <br><strong>Imported (currently):</strong> Steps, Heart Rate (daily avg), Sleep Duration (asleep).
                                </small>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-upload"></i> Upload & Import Apple Health
                            </button>
                        </form>
                    </div>
                    <div id="appleHealthImportResults" class="garmin-status" style="margin-top: 20px;">
                        <!-- Import results will be displayed here -->
                    </div>
                </div>

                <div class="garmin-section">
                    <h3><i class="fas fa-android"></i> Android (Google Fit / Health Connect) Import</h3>
                    <div class="upload-section">
                        <form id="androidHealthUploadForm" class="upload-form">
                            <div class="form-group">
                                <label for="androidHealthFile">Upload Google Takeout ZIP (or extracted CSV)</label>
                                <input type="file" id="androidHealthFile" name="androidHealthFile" accept=".zip,.csv" required>
                                <small class="form-help">
                                    Web apps can’t directly read Android health data on-device. The practical way is exporting:
                                    <br><strong>Google Fit:</strong> Google Takeout → select Google Fit → export as ZIP → upload the ZIP here.
                                    <br><strong>Health Connect:</strong> if you have an export ZIP/CSV, upload it here (best-effort parsing).
                                    <br><strong>Imported (currently):</strong> Steps, Heart Rate (daily avg), Sleep Duration (best-effort if present).
                                </small>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-upload"></i> Upload & Import Android Data
                            </button>
                        </form>
                    </div>
                    <div id="androidHealthImportResults" class="garmin-status" style="margin-top: 20px;">
                        <!-- Import results will be displayed here -->
                    </div>
                </div>

                <div class="garmin-section">
                    <h3><i class="fas fa-info-circle"></i> Supported Data Types</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="background: rgba(102, 126, 234, 0.05); border-radius: 12px; padding: 20px; border-left: 4px solid #667eea;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">
                                <i class="fas fa-walking" style="color: #667eea;"></i> Activity Data
                            </h4>
                            <ul style="color: #718096; font-size: 14px; margin: 0; padding-left: 20px;">
                                <li>Steps</li>
                                <li>Calories burned</li>
                                <li>Distance</li>
                                <li>Active minutes</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.05); border-radius: 12px; padding: 20px; border-left: 4px solid #667eea;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">
                                <i class="fas fa-bed" style="color: #667eea;"></i> Sleep Data
                            </h4>
                            <ul style="color: #718096; font-size: 14px; margin: 0; padding-left: 20px;">
                                <li>Sleep duration</li>
                                <li>Deep sleep hours</li>
                                <li>REM sleep hours</li>
                                <li>Bedtime & wake time</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.05); border-radius: 12px; padding: 20px; border-left: 4px solid #667eea;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">
                                <i class="fas fa-heart" style="color: #667eea;"></i> Health Metrics
                            </h4>
                            <ul style="color: #718096; font-size: 14px; margin: 0; padding-left: 20px;">
                                <li>Heart rate (average)</li>
                                <li>Stress levels</li>
                                <li>Activity intensity</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="garmin-section">
                    <h3><i class="fas fa-download"></i> Data Export</h3>
                    <div class="garmin-controls">
                        <button id="exportDataBtn" class="btn btn-secondary">
                            <i class="fas fa-download"></i> Export Your Data
                        </button>
                        <small class="form-help" style="display: block; margin-top: 10px;">
                            Export all your health data as a JSON file for backup or use in other applications.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

            </div> <!-- end app-main-content -->
        </div> <!-- end app-main-layout -->

        <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="toast-content">
            <i class="toast-icon"></i>
            <span class="toast-message"></span>
        </div>
    </div>

    <script src="js/auth-client.js"></script>
    <script src="script.js"></script>
</body>
</html>

